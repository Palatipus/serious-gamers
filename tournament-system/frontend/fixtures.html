<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fixtures • Serious Gamers</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>
<header>
  <h1>SERIOUS GAMERS • Fixtures</h1>
  <p>Enter scores, click Save. Only the director can Confirm & lock.</p>
</header>

<main>
  <div class="table-wrap">
    <div id="fixturesContainer"></div>
  </div>
  <div class="center"><a href="groups.html">View Groups</a> • <a href="admin.html">Admin</a></div>
</main>

<footer><p>Contact: <em>casperagyengo12@gmail.com</em></p></footer>

<script type="module">
const container = document.getElementById('fixturesContainer');

function fixtureRow(m) {
  const disabled = m.confirmed ? 'disabled' : '';
  const lockBadge = m.confirmed ? ' <span class="badge">Locked</span>' : '';
  return `
<tr data-id="${m.id}">
  <td>${m.group_name || '-'}</td>
  <td>${m.home_team_name}</td>
  <td><input type="number" min="0" class="hs" value="${m.home_score ?? ''}" ${disabled}></td>
  <td>${m.away_team_name}</td>
  <td><input type="number" min="0" class="as" value="${m.away_score ?? ''}" ${disabled}></td>
  <td>
    <button class="saveBtn" ${disabled}>Save</button>
    <button class="confirmBtn" ${disabled}>Confirm</button>
    ${lockBadge}
  </td>
</tr>`;
}

async function load() {
  const r = await fetch('/api/fixtures');
  const fx = await r.json();
  const by = {};
  fx.forEach(m => {
    const key = `${m.round}-${m.group_name || ''}`;
    by[key] = by[key] || [];
    by[key].push(m);
  });
  const keys = Object.keys(by).sort();
  container.innerHTML = keys.map(k => {
    const [round, grp] = k.split('-');
    const title = round === 'Group' ? `Group ${grp}` : round;
    const rows = by[k].map(fixtureRow).join('');
    return `
      <div class="card">
        <h3>${title}</h3>
        <table>
          <thead><tr><th>Group</th><th>Home</th><th>H</th><th>Away</th><th>A</th><th>Actions</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  }).join('');

  // bind buttons
  container.querySelectorAll('.saveBtn').forEach(btn => {
    btn.onclick = async (e) => {
      const tr = e.target.closest('tr');
      const id = Number(tr.dataset.id);
      const hs = tr.querySelector('.hs').value;
      const as = tr.querySelector('.as').value;
      const r = await fetch('/api/fixtures/score', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ fixture_id: id, home_score: Number(hs), away_score: Number(as) })
      });
      const j = await r.json();
      if (!r.ok) { alert(j.error || 'Failed'); return; }
      load();
    };
  });

  container.querySelectorAll('.confirmBtn').forEach(btn => {
    btn.onclick = async (e) => {
      const pwd = prompt('Enter confirm password to lock this score:');
      if (!pwd) return;
      const tr = e.target.closest('tr');
      const id = Number(tr.dataset.id);
      const r = await fetch('/api/fixtures/confirm', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ fixture_id: id, confirm_password: pwd })
      });
      const j = await r.json();
      if (!r.ok) { alert(j.error || 'Failed'); return; }
      load();
    };
  });
}

load();
setInterval(load, 8000);
</script>
</body>
</html>
