<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tournaments ‚Äî Serious Gamers</title>
  <link rel="stylesheet" href="portal.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>
<div class="main">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:12px">
      <button class="hamburger" id="hamburgerBtn">‚ò∞</button>
      <span class="topbar-title">TOURNAMENTS</span>
    </div>
    <div class="topbar-right">
      <div class="chip chip-cyan" id="filterActive" style="cursor:pointer" onclick="setFilter('active')">Active</div>
      <div class="chip chip-dim"  id="filterAll"    style="cursor:pointer" onclick="setFilter('all')">All</div>
      <div class="chip chip-dim"  id="filterDone"   style="cursor:pointer" onclick="setFilter('completed')">Past</div>
    </div>
  </div>
  <div class="page-content">
    <div id="msgArea"></div>
    <div id="tournamentList">
      <div class="empty">
        <div class="spinner" style="width:36px;height:36px;border-width:3px;margin:0 auto 16px"></div>
        <div class="empty-title">Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- Register Modal -->

<div class="modal-backdrop" id="regModal">
  <div class="modal">
    <div class="modal-title">REGISTER FOR TOURNAMENT</div>
    <div id="regModalInfo" style="font-size:0.85rem;color:var(--text-dim);margin-bottom:16px"></div>
    <div id="regMsgArea"></div>
    <div class="form-row">
      <label class="form-label">Choose Your Team</label>
      <select id="teamSelect" class="form-select"><option value="">Loading teams...</option></select>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-cyan" onclick="submitRegister()">Register</button>
    </div>
  </div>
</div>

<script type="module">
import { buildNav } from './nav.js';
const player = buildNav('tournaments');

let allTournaments = [];
let currentFilter = 'active';
let selectedTournamentId = null;

// Load data FIRST, then render ‚Äî this was the bug
async function load() {
  try {
    const res = await fetch('/api/tournaments');
    if (!res.ok) throw new Error('Server error ' + res.status);
    allTournaments = await res.json();
    render();
  } catch (err) {
    document.getElementById('tournamentList').innerHTML =
      `<div class="alert alert-error">Could not load tournaments: ${err.message}</div>`;
  }
}

window.setFilter = function(f) {
  currentFilter = f;
  document.getElementById('filterActive').className = 'chip chip-dim';
  document.getElementById('filterAll').className    = 'chip chip-dim';
  document.getElementById('filterDone').className   = 'chip chip-dim';
  const map = { active: 'filterActive', all: 'filterAll', completed: 'filterDone' };
  if (map[f]) document.getElementById(map[f]).className = 'chip chip-cyan';
  render();
};

function render() {
  let list = allTournaments;
  if (currentFilter === 'active')    list = allTournaments.filter(t => t.status !== 'completed');
  if (currentFilter === 'completed') list = allTournaments.filter(t => t.status === 'completed');

  const el = document.getElementById('tournamentList');

  if (!list.length) {
    el.innerHTML = `
      <div class="empty">
        <div class="empty-icon">üèÜ</div>
        <div class="empty-title">NO TOURNAMENTS</div>
        <div class="empty-sub">${
          currentFilter === 'active'
            ? 'No active tournaments right now. The admin will create one soon!'
            : 'No tournaments found for this filter.'
        }</div>
      </div>`;
    return;
  }

  const statusMap = {
    registration: { chip: 'chip-green', label: '‚óè Registration Open' },
    group_stage:  { chip: 'chip-cyan',  label: '‚óè Group Stage' },
    knockout:     { chip: 'chip-gold',  label: '‚óè Knockout Stage' },
    completed:    { chip: 'chip-dim',   label: '‚úì Completed' },
  };

  el.innerHTML = list.map(t => {
    const pct    = Math.round((t.registered_count / t.max_players) * 100);
    const isFull = t.registered_count >= t.max_players;
    const s      = statusMap[t.status] || statusMap.completed;

    let action = '';
    if (t.status === 'registration' && !isFull) {
      action = `<button class="btn btn-green btn-sm" onclick="openRegModal(${t.id}, '${t.name.replace(/'/g,"\\'")}', ${t.max_players})">Register ‚Üí</button>`;
    } else if (t.status === 'registration' && isFull) {
      action = `<span class="chip chip-red">Full</span>`;
    } else {
      action = `<button class="btn btn-ghost btn-sm" onclick="location.href='tournament.html?id=${t.id}'">View ‚Üí</button>`;
    }

    return `
      <div class="tournament-card status-${t.status}" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:10px">
          <div style="min-width:0">
            <div class="t-name" style="cursor:pointer" onclick="location.href='tournament.html?id=${t.id}'">${t.name}</div>
            ${t.description ? `<div class="t-desc">${t.description}</div>` : ''}
          </div>
          <span class="chip ${s.chip}" style="white-space:nowrap;flex-shrink:0">${s.label}</span>
        </div>
        <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
          <div style="flex:1;min-width:120px">
            <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
            <div style="font-size:0.72rem;color:var(--text-dim);margin-top:3px">${t.registered_count} / ${t.max_players} players</div>
          </div>
          <div style="font-size:0.78rem;color:var(--text-dim);white-space:nowrap">${t.max_players}-player bracket</div>
          ${action}
        </div>
      </div>`;
  }).join('');
}

window.openRegModal = async function(id, name, maxPlayers) {
  selectedTournamentId = id;
  document.getElementById('regModalInfo').textContent = `Registering for: ${name} (${maxPlayers}-player bracket)`;
  document.getElementById('regMsgArea').innerHTML = '';
  document.getElementById('teamSelect').innerHTML = '<option value="">Loading teams...</option>';
  document.getElementById('regModal').classList.add('open');

  try {
    const res = await fetch(`/api/tournaments/${id}/available-teams`);
    const teams = await res.json();
    const sel = document.getElementById('teamSelect');
    if (!teams.length) {
      sel.innerHTML = '<option value="">No teams available</option>';
    } else {
      sel.innerHTML = '<option value="">-- Pick Your Team --</option>' +
        teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }
  } catch (err) {
    document.getElementById('teamSelect').innerHTML = '<option value="">Failed to load teams</option>';
  }
};

window.closeModal = function() {
  document.getElementById('regModal').classList.remove('open');
};

window.submitRegister = async function() {
  const team_id = parseInt(document.getElementById('teamSelect').value);
  const msg = document.getElementById('regMsgArea');
  if (!team_id) {
    msg.innerHTML = '<div class="alert alert-error">Pick a team first.</div>';
    return;
  }
  try {
    const res = await fetch(`/api/tournaments/${selectedTournamentId}/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ player_id: player.id, team_id })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Registration failed');
    msg.innerHTML = '<div class="alert alert-success">Registered! üéâ</div>';
    setTimeout(closeModal, 1200);
    load();
  } catch (err) {
    msg.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
  }
};

document.getElementById('regModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});

// Always load first, render happens inside load() after data arrives
load();
</script>

</body>
</html>