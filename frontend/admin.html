<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin ‚Äî Serious Gamers</title>
  <link rel="stylesheet" href="portal.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { display:flex; min-height:100vh; }
    .admin-main { flex:1; display:flex; flex-direction:column; }
    .login-wrap { display:flex; align-items:center; justify-content:center; flex:1; }
    .login-box { width:100%; max-width:380px; }
    .login-box h2 { font-family:'Bebas Neue',cursive; font-size:1.5rem; letter-spacing:3px; color:var(--red); margin-bottom:6px; }
    .login-box p { font-size:0.82rem; color:var(--text-dim); margin-bottom:24px; }
    .t-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:18px 20px; margin-bottom:10px; }
    .t-card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
    .t-card-name { font-family:'Bebas Neue',cursive; font-size:1.2rem; letter-spacing:2px; }
    .t-card-actions { display:flex; gap:6px; flex-wrap:wrap; }
    .match-row { display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid var(--border); flex-wrap:wrap; }
    .match-row:last-child { border-bottom:none; }
    .match-teams { flex:1; font-size:0.88rem; min-width:180px; }
    .match-score-disp { font-family:'Bebas Neue',cursive; font-size:1.2rem; color:var(--gold); min-width:50px; text-align:center; }
  </style>
</head>
<body>
<div class="admin-main" id="adminMain">
  <!-- LOGIN -->
  <div class="login-wrap" id="loginWrap">
    <div class="login-box card">
      <h2>üîê ADMIN LOGIN</h2>
      <p>This area is for tournament administrators only.</p>
      <div id="loginMsg"></div>
      <div class="form-row">
        <label class="form-label">Admin Password</label>
        <input type="password" id="adminPwd" class="form-input" placeholder="Enter password">
      </div>
      <button class="btn btn-red btn-lg" style="width:100%" onclick="adminLogin()">Login as Admin</button>
    </div>
  </div>

  <!-- PANEL -->
  <div id="adminPanel" style="display:none;flex-direction:column;flex:1">
    <div class="topbar">
      <span class="topbar-title" style="color:var(--red)">‚ö° ADMIN CONTROL</span>
      <div class="topbar-right">
        <span style="font-size:0.78rem;color:var(--text-dim)">Admin Mode</span>
        <button class="btn btn-ghost btn-sm" onclick="adminLogout()">Logout</button>
      </div>
    </div>
    <div class="page-content">
      <div id="adminMsg" style="margin-bottom:12px"></div>

      <!-- Create tournament -->
      <div style="margin-bottom:32px">
        <div class="section-header"><div class="section-title">CREATE TOURNAMENT</div></div>
        <div class="card" style="max-width:560px">
          <div class="grid-2" style="gap:14px">
            <div class="form-row" style="margin:0">
              <label class="form-label">Tournament Name</label>
              <input type="text" id="tName" class="form-input" placeholder="e.g. Season 1">
            </div>
            <div class="form-row" style="margin:0">
              <label class="form-label">Max Players</label>
              <select id="tSize" class="form-select">
                <option value="16">16 Players (4 Groups)</option>
                <option value="32" selected>32 Players (8 Groups)</option>
              </select>
            </div>
          </div>
          <div class="form-row" style="margin:14px 0 16px">
            <label class="form-label">Description (optional)</label>
            <input type="text" id="tDesc" class="form-input" placeholder="e.g. First ever Serious Gamers season">
          </div>
          <button class="btn btn-cyan" onclick="createTournament()">Create Tournament ‚Üí</button>
        </div>
      </div>

      <!-- Tournament list -->
      <div class="section-header"><div class="section-title">ALL TOURNAMENTS</div></div>
      <div id="adminTournamentList"></div>
    </div>
  </div>
</div>

<!-- Matches modal for a tournament -->
<div class="modal-backdrop" id="matchModal">
  <div class="modal" style="max-width:700px;width:95vw">
    <div class="modal-title" id="matchModalTitle">MATCHES</div>
    <div id="matchModalMsg"></div>
    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
      <button class="btn btn-ghost btn-sm" onclick="setMatchFilter('all')">All</button>
      <button class="btn btn-ghost btn-sm" onclick="setMatchFilter('pending')">Pending</button>
      <button class="btn btn-ghost btn-sm" onclick="setMatchFilter('confirmed')">Confirmed</button>
    </div>
    <div id="matchModalList" style="max-height:55vh;overflow-y:auto"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeMatchModal()">Close</button>
      <button class="btn btn-red btn-sm" onclick="confirmAllMatches()">Confirm All With Scores</button>
    </div>
  </div>
</div>

<script>
  let adminPwd = '';
  let currentTid = null;
  let allAdminMatches = [];
  let matchFilter = 'all';

  document.getElementById('adminPwd').addEventListener('keydown', e => { if(e.key==='Enter') adminLogin(); });

  async function adminLogin() {
    const pwd = document.getElementById('adminPwd').value;
    if (!pwd) return;
    // Quick verify with a lightweight admin request
    try {
      const res = await fetch('/api/tournaments', { method:'GET' });
      // We verify password by trying an admin action
      const testRes = await fetch('/api/tournaments', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({password: pwd, name:'__test__', max_players:16})
      });
      if (testRes.status === 403) {
        document.getElementById('loginMsg').innerHTML = '<div class="alert alert-error">Wrong password.</div>';
        return;
      }
      // Delete the test tournament if it was created
      const testData = await testRes.json();
      if (testData.tournament) {
        await fetch(`/api/tournaments/${testData.tournament.id}`, {
          method:'DELETE', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({password: pwd})
        });
      }
    } catch(e) {}

    adminPwd = pwd;
    document.getElementById('loginWrap').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'flex';
    loadAdminTournaments();
  }

  function adminLogout() {
    adminPwd = '';
    document.getElementById('loginWrap').style.display = 'flex';
    document.getElementById('adminPanel').style.display = 'none';
    document.getElementById('adminPwd').value = '';
  }

  async function loadAdminTournaments() {
    const res = await fetch('/api/tournaments');
    const tournaments = await res.json();
    const el = document.getElementById('adminTournamentList');

    if (!tournaments.length) {
      el.innerHTML = '<div class="empty"><div class="empty-icon">üèÜ</div><div class="empty-title">NO TOURNAMENTS YET</div><div class="empty-sub">Create one above to get started.</div></div>';
      return;
    }

    el.innerHTML = tournaments.map(t => {
      const statusMap = {
        registration: { chip:'chip-green', label:'‚óè Open' },
        group_stage:  { chip:'chip-cyan',  label:'‚óè Groups' },
        knockout:     { chip:'chip-gold',  label:'‚óè Knockout' },
        completed:    { chip:'chip-dim',   label:'‚úì Done' },
      };
      const s = statusMap[t.status] || statusMap.completed;
      const pct = Math.round((t.registered_count / t.max_players)*100);

      // Build action buttons based on status
      let actions = '';
      if (t.status === 'registration') {
        actions += `<button class="btn btn-cyan btn-sm" onclick="generateGroups(${t.id})">üé≤ Generate Groups</button>`;
      }
      if (t.status === 'group_stage') {
        actions += `<button class="btn btn-cyan btn-sm" onclick="openMatchModal(${t.id}, '${t.name.replace(/'/g,"\\'")}')">‚öΩ Manage Matches</button>`;
        actions += `<button class="btn btn-gold btn-sm" onclick="generateKnockout(${t.id})">üèÜ Gen Knockout</button>`;
      }
      if (t.status === 'knockout') {
        actions += `<button class="btn btn-cyan btn-sm" onclick="openMatchModal(${t.id}, '${t.name.replace(/'/g,"\\'")}')">‚öΩ Manage Matches</button>`;
        actions += `<button class="btn btn-ghost btn-sm" onclick="setStatus(${t.id},'completed')">‚úì Complete</button>`;
      }
      actions += `<button class="btn btn-ghost btn-sm" onclick="deleteTournament(${t.id})">üóë</button>`;

      return `
        <div class="t-card">
          <div class="t-card-header">
            <div>
              <div class="t-card-name">${t.name}</div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:4px;flex-wrap:wrap">
                <span class="chip ${s.chip}">${s.label}</span>
                <span style="font-size:0.72rem;color:var(--text-dim)">${t.max_players}-player ¬∑ ${t.registered_count} registered</span>
              </div>
            </div>
          </div>
          <div class="progress-bar" style="margin-bottom:12px"><div class="progress-fill" style="width:${pct}%"></div></div>
          <div class="t-card-actions">${actions}</div>
        </div>`;
    }).join('');
  }

  async function createTournament() {
    const name = document.getElementById('tName').value.trim();
    const max_players = parseInt(document.getElementById('tSize').value);
    const description = document.getElementById('tDesc').value.trim();
    if (!name) { showAdminMsg('Tournament name required.', 'error'); return; }

    try {
      const res = await fetch('/api/tournaments', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({password:adminPwd, name, description, max_players})
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || data.error);
      showAdminMsg(`"${name}" created!`, 'success');
      document.getElementById('tName').value = '';
      document.getElementById('tDesc').value = '';
      loadAdminTournaments();
    } catch(err) { showAdminMsg(err.message, 'error'); }
  }

  async function generateGroups(tid) {
    if (!confirm('Generate random group draw? This will lock registrations and create fixtures.')) return;
    try {
      showAdminMsg('Generating groups...', 'info');
      const res = await fetch(`/api/tournaments/${tid}/groups/generate`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({password:adminPwd})
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || data.error);
      showAdminMsg(data.message, 'success');
      loadAdminTournaments();
    } catch(err) { showAdminMsg(err.message, 'error'); }
  }

  async function generateKnockout(tid) {
    if (!confirm('Generate knockout bracket from current group standings?')) return;
    try {
      showAdminMsg('Generating bracket...', 'info');
      const res = await fetch(`/api/tournaments/${tid}/matches/generate-knockout`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({password:adminPwd})
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || data.error);
      showAdminMsg(data.message, 'success');
      loadAdminTournaments();
    } catch(err) { showAdminMsg(err.message, 'error'); }
  }

  async function setStatus(tid, status) {
    try {
      const res = await fetch(`/api/tournaments/${tid}/status`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({password:adminPwd, status})
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);
      showAdminMsg(data.message, 'success');
      loadAdminTournaments();
    } catch(err) { showAdminMsg(err.message, 'error'); }
  }

  async function deleteTournament(tid) {
    if (!confirm('DELETE this tournament and all its data? This cannot be undone.')) return;
    try {
      const res = await fetch(`/api/tournaments/${tid}`, {
        method:'DELETE', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({password:adminPwd})
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);
      showAdminMsg('Tournament deleted.', 'success');
      loadAdminTournaments();
    } catch(err) { showAdminMsg(err.message, 'error'); }
  }

  async function openMatchModal(tid, name) {
    currentTid = tid;
    matchFilter = 'all';
    document.getElementById('matchModalTitle').textContent = `MATCHES ‚Äî ${name.toUpperCase()}`;
    document.getElementById('matchModal').classList.add('open');
    await loadMatchModal();
  }

  async function loadMatchModal() {
    const res = await fetch(`/api/tournaments/${currentTid}/matches`);
    allAdminMatches = await res.json();
    renderMatchModal();
  }

  window.setMatchFilter = function(f) { matchFilter = f; renderMatchModal(); };

  function renderMatchModal() {
    let list = allAdminMatches;
    if (matchFilter === 'pending') list = allAdminMatches.filter(m => !m.confirmed);
    if (matchFilter === 'confirmed') list = allAdminMatches.filter(m => m.confirmed);

    const el = document.getElementById('matchModalList');
    if (!list.length) { el.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-dim)">No matches found.</div>'; return; }

    el.innerHTML = list.map(m => {
      const hasScore = m.home_score !== null && m.away_score !== null;
      const scoreDisp = hasScore ? `${m.home_score} ‚Äì ${m.away_score}` : '‚Äì vs ‚Äì';
      const stageLabel = (m.stage || 'group').replace(/-/g,' ').replace(/\b\w/g,l=>l.toUpperCase());
      const groupTag = m.group_name ? ` ¬∑ Grp ${m.group_name}` : '';

      return `
        <div class="match-row ${m.confirmed?'':''}">
          <div style="font-size:0.65rem;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);min-width:80px">${stageLabel}${groupTag}</div>
          <div class="match-teams">
            <div style="font-weight:600">${m.home_player}</div>
            <div style="font-size:0.75rem;color:var(--text-dim)">${m.home_team_name}</div>
          </div>
          <div class="match-score-disp">${scoreDisp}</div>
          <div class="match-teams" style="text-align:right">
            <div style="font-weight:600">${m.away_player}</div>
            <div style="font-size:0.75rem;color:var(--text-dim)">${m.away_team_name}</div>
          </div>
          ${m.confirmed
            ? '<span class="chip chip-green" style="white-space:nowrap">‚úì Locked</span>'
            : `<button class="btn btn-red btn-sm" onclick="confirmMatch(${m.id})" ${!hasScore?'disabled title="No score entered"':''}>Confirm</button>`
          }
        </div>`;
    }).join('');
  }

  async function confirmMatch(id) {
    try {
      const res = await fetch(`/api/tournaments/${currentTid}/matches/${id}/confirm`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({password:adminPwd})
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);
      showMatchMsg(data.message, 'success');
      await loadMatchModal();
    } catch(err) { showMatchMsg(err.message, 'error'); }
  }

  async function confirmAllMatches() {
    if (!confirm('Confirm ALL matches that have scores entered?')) return;
    try {
      const res = await fetch(`/api/tournaments/${currentTid}/matches/confirm-all`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({password:adminPwd})
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);
      showMatchMsg(data.message, 'success');
      await loadMatchModal();
    } catch(err) { showMatchMsg(err.message, 'error'); }
  }

  window.closeMatchModal = function() {
    document.getElementById('matchModal').classList.remove('open');
    currentTid = null;
    loadAdminTournaments();
  };

  document.getElementById('matchModal').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeMatchModal();
  });

  function showAdminMsg(text, type='info') {
    const el = document.getElementById('adminMsg');
    el.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
    if (type !== 'error') setTimeout(()=>el.innerHTML='', 4000);
  }

  function showMatchMsg(text, type='info') {
    const el = document.getElementById('matchModalMsg');
    el.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
    if (type !== 'error') setTimeout(()=>el.innerHTML='', 3000);
  }
</script>
</body>
</html>
