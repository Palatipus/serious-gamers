<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fixtures — Good Gamers</title>
  <link rel="stylesheet" href="tournament.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    .fixtures-wrap {
      width: 100%;
      max-width: 900px;
      padding: 0 20px 80px;
    }

    .stage-section {
      margin-bottom: 40px;
    }

    .stage-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      letter-spacing: 3px;
      color: var(--text-dim);
      text-transform: uppercase;
      padding: 10px 0 6px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .match-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 10px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
      backdrop-filter: blur(6px);
      transition: border-color 0.2s;
    }

    .match-card.confirmed {
      border-color: rgba(0, 200, 100, 0.3);
      background: rgba(0, 200, 100, 0.04);
    }

    .match-card:hover:not(.confirmed) {
      border-color: rgba(0, 191, 255, 0.4);
    }

    .team-side {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .team-side.right {
      text-align: right;
      align-items: flex-end;
    }

    .team-name {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text);
    }

    .player-name {
      font-size: 0.78rem;
      color: var(--text-dim);
    }

    .score-area {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-direction: column;
      min-width: 160px;
    }

    .score-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .match-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .btn-sm {
      padding: 5px 12px;
      font-size: 0.78rem;
    }

    .group-tag {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.65rem;
      color: var(--primary);
      letter-spacing: 1px;
      margin-bottom: 2px;
    }

    .filter-bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .filter-btn {
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-dim);
      font-family: 'Rajdhani', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
    }

    .filter-btn.active,
    .filter-btn:hover {
      background: rgba(0, 191, 255, 0.1);
      border-color: var(--primary);
      color: var(--primary);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }

    .empty-state h3 {
      font-family: 'Orbitron', sans-serif;
      color: var(--text);
      margin-bottom: 8px;
    }

    .msg-area {
      min-height: 30px;
      margin-bottom: 10px;
    }

    @media (max-width: 600px) {
      .match-card {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .team-side.right { text-align: left; align-items: flex-start; }
      .score-area { flex-direction: row; flex-wrap: wrap; justify-content: space-between; }
    }
  </style>
</head>
<body>

<nav>
  <div class="nav-inner">
    <a href="index.html" class="nav-logo">⚽ SERIOUS GAMERS</a>
    <div class="nav-links">
      <a href="index.html">Register</a>
      <a href="groups.html">Groups</a>
      <a href="fixtures.html" class="active">Fixtures</a>
      <a href="bracket.html">Bracket</a>
      <a href="admin.html">Admin</a>
    </div>
  </div>
</nav>

<div class="page-header">
  <h1>FIXTURES</h1>
  <p>Enter scores · Results confirmed by admin</p>
</div>

<div class="fixtures-wrap">
  <div class="msg-area" id="msgArea"></div>

  <div class="filter-bar" id="filterBar">
    <button class="filter-btn active" data-filter="all">All</button>
  </div>

  <div id="fixturesContainer">
    <div class="empty-state">
      <div class="spinner" style="width:40px;height:40px;border-width:3px;margin:0 auto 20px;"></div>
      <h3>Loading fixtures...</h3>
    </div>
  </div>
</div>

<footer>
  <p>Contact: <em>casperagyengo12@gmail.com</em></p>
</footer>

<script type="module">
  let allMatches = [];
  let activeFilter = 'all';

  async function loadFixtures() {
    try {
      const res = await fetch('/api/matches');
      allMatches = await res.json();
      buildFilters();
      renderMatches();
    } catch (err) {
      document.getElementById('fixturesContainer').innerHTML =
        `<div class="alert alert-error">Failed to load fixtures.</div>`;
    }
  }

  function buildFilters() {
    const bar = document.getElementById('filterBar');
    const groups = [...new Set(allMatches.filter(m => m.group_name).map(m => m.group_name))].sort();
    const stages = [...new Set(allMatches.filter(m => !m.group_name).map(m => m.stage))];

    bar.innerHTML = `<button class="filter-btn ${activeFilter === 'all' ? 'active' : ''}" data-filter="all">All</button>`;
    
    if (groups.length) {
      bar.innerHTML += `<button class="filter-btn ${activeFilter === 'group' ? 'active' : ''}" data-filter="group">Group Stage</button>`;
      groups.forEach(g => {
        bar.innerHTML += `<button class="filter-btn ${activeFilter === g ? 'active' : ''}" data-filter="${g}">Group ${g}</button>`;
      });
    }
    
    stages.forEach(s => {
      const label = s.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
      bar.innerHTML += `<button class="filter-btn ${activeFilter === s ? 'active' : ''}" data-filter="${s}">${label}</button>`;
    });

    bar.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        activeFilter = btn.dataset.filter;
        bar.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderMatches();
      });
    });
  }

  function renderMatches() {
    let filtered = allMatches;
    if (activeFilter === 'group') filtered = allMatches.filter(m => m.stage === 'group');
    else if (activeFilter !== 'all') {
      filtered = allMatches.filter(m => m.group_name === activeFilter || m.stage === activeFilter);
    }

    if (!filtered.length) {
      document.getElementById('fixturesContainer').innerHTML =
        `<div class="empty-state"><h3>No fixtures found</h3><p>No matches available for this filter.</p></div>`;
      return;
    }

    // Group by stage then group_name
    const sections = {};
    filtered.forEach(m => {
      const key = m.stage === 'group' ? `group_${m.group_name}` : m.stage;
      if (!sections[key]) sections[key] = { title: '', matches: [] };
      if (m.stage === 'group') sections[key].title = `Group ${m.group_name}`;
      else sections[key].title = m.stage.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
      sections[key].matches.push(m);
    });

    const stageOrder = ['group', 'quarter-final', 'semi-final', 'final'];
    const sortedKeys = Object.keys(sections).sort((a, b) => {
      const ai = stageOrder.indexOf(sections[a].matches[0].stage);
      const bi = stageOrder.indexOf(sections[b].matches[0].stage);
      if (ai !== bi) return ai - bi;
      return a.localeCompare(b);
    });

    let html = '';
    sortedKeys.forEach(key => {
      const sec = sections[key];
      html += `<div class="stage-section">
        <div class="stage-title">${sec.title}</div>`;
      sec.matches.forEach(m => {
        html += renderMatchCard(m);
      });
      html += `</div>`;
    });

    document.getElementById('fixturesContainer').innerHTML = html;

    // Attach listeners
    document.querySelectorAll('.save-score-btn').forEach(btn => {
      btn.addEventListener('click', () => saveScore(btn.dataset.id));
    });
  }

  function renderMatchCard(m) {
    const confirmed = m.confirmed;
    const hasScore = m.home_score !== null && m.away_score !== null;

    const scoreHtml = confirmed
      ? `<div class="score-row">
           <span style="font-family:'Orbitron',sans-serif;font-size:1.5rem;font-weight:900;color:var(--gold)">
             ${m.home_score} : ${m.away_score}
           </span>
         </div>
         <span class="badge badge-confirmed">✓ Confirmed</span>`
      : `<div class="score-row">
           <input class="score-input" type="number" min="0" max="99" id="hs_${m.id}"
             value="${m.home_score !== null ? m.home_score : ''}" placeholder="-">
           <span class="vs-text">VS</span>
           <input class="score-input" type="number" min="0" max="99" id="as_${m.id}"
             value="${m.away_score !== null ? m.away_score : ''}" placeholder="-">
         </div>
         <div class="match-actions">
           <button class="btn btn-primary btn-sm save-score-btn" data-id="${m.id}">Save</button>
           ${hasScore ? '<span class="badge badge-pending">Pending Confirm</span>' : ''}
         </div>`;

    return `
      <div class="match-card ${confirmed ? 'confirmed' : ''}" id="match_${m.id}">
        <div class="team-side">
          <div class="group-tag">${m.group_name ? 'GRP ' + m.group_name : m.stage?.toUpperCase()}</div>
          <div class="team-name">${m.home_team_name}</div>
          <div class="player-name">${m.home_player}</div>
        </div>
        <div class="score-area">${scoreHtml}</div>
        <div class="team-side right">
          <div class="group-tag"> </div>
          <div class="team-name">${m.away_team_name}</div>
          <div class="player-name">${m.away_player}</div>
        </div>
      </div>`;
  }

  async function saveScore(id) {
    const hs = document.getElementById(`hs_${id}`)?.value;
    const as = document.getElementById(`as_${id}`)?.value;

    if (hs === '' || as === '') return showMsg('Enter both scores before saving.', 'error');

    try {
      const res = await fetch(`/api/matches/${id}/score`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ home_score: parseInt(hs), away_score: parseInt(as) })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Save failed');
      showMsg(data.message, 'success');
      await loadFixtures();
    } catch (err) {
      showMsg(err.message, 'error');
    }
  }

  function showMsg(text, type = 'info') {
    const area = document.getElementById('msgArea');
    area.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
    setTimeout(() => area.innerHTML = '', 3000);
  }

  loadFixtures();
</script>

</body>
</html>
