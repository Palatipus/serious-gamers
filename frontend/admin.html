<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin â€” Serious Gamers</title>
  <link rel="stylesheet" href="portal.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { display:flex; min-height:100vh; }
    .admin-main { flex:1; display:flex; flex-direction:column; }
    .login-wrap { display:flex; align-items:center; justify-content:center; flex:1; padding:20px; }
    .login-box  { width:100%; max-width:380px; }
    .login-box h2 { font-family:'Bebas Neue',cursive; font-size:1.5rem; letter-spacing:3px; color:var(--red); margin-bottom:6px; }
    .login-box p  { font-size:0.82rem; color:var(--text-dim); margin-bottom:24px; }

    /* Format picker toggle */
    .format-toggle { display:flex; gap:0; border:1px solid var(--border); border-radius:8px; overflow:hidden; }
    .format-opt { flex:1; padding:10px; text-align:center; font-size:0.82rem; font-weight:600; cursor:pointer; color:var(--text-dim); background:var(--surface2); transition:all 0.15s; border:none; }
    .format-opt.active { background:var(--cyan); color:#000; }
    .format-desc { font-size:0.75rem; color:var(--text-dim); margin-top:8px; min-height:32px; }

    /* Tournament cards */
    .t-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:18px 20px; margin-bottom:10px; }
    .t-card-name { font-family:'Bebas Neue',cursive; font-size:1.2rem; letter-spacing:2px; }
    .t-card-actions { display:flex; gap:6px; flex-wrap:wrap; margin-top:12px; }

    /* Match rows in modal */
    .match-row { display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid var(--border); flex-wrap:wrap; }
    .match-row:last-child { border-bottom:none; }
    .match-teams { flex:1; min-width:140px; font-size:0.85rem; }
    .match-score-disp { font-family:'Bebas Neue',cursive; font-size:1.2rem; color:var(--gold); min-width:54px; text-align:center; }
  </style>
</head>
<body>
<div class="admin-main">

  <!-- â”€â”€ LOGIN â”€â”€ -->
  <div class="login-wrap" id="loginWrap">
    <div class="login-box card">
      <h2>ğŸ” ADMIN LOGIN</h2>
      <p>This area is for tournament administrators only.</p>
      <div id="loginMsg"></div>
      <div class="form-row">
        <label class="form-label">Admin Password</label>
        <input type="password" id="adminPwd" class="form-input" placeholder="Enter password">
      </div>
      <button class="btn btn-red btn-lg" style="width:100%" onclick="adminLogin()">Login as Admin</button>
      <div style="text-align:center;margin-top:14px">
        <a href="index.html" style="font-size:0.78rem;color:var(--text-dim);text-decoration:none">â† Back to Player Portal</a>
      </div>
    </div>
  </div>

  <!-- â”€â”€ ADMIN PANEL â”€â”€ -->
  <div id="adminPanel" style="display:none;flex-direction:column;flex:1">
    <div class="topbar">
      <span class="topbar-title" style="color:var(--red)">âš¡ ADMIN CONTROL PANEL</span>
      <div class="topbar-right">
        <a href="index.html" class="btn btn-ghost btn-sm">Player Portal</a>
        <button class="btn btn-ghost btn-sm" onclick="adminLogout()">Logout</button>
      </div>
    </div>

    <div class="page-content">
      <div id="adminMsg" style="margin-bottom:14px"></div>

      <!-- â”€â”€ CREATE TOURNAMENT â”€â”€ -->
      <div style="margin-bottom:36px">
        <div class="section-header">
          <div class="section-title">CREATE TOURNAMENT</div>
        </div>
        <div class="card" style="max-width:620px">

          <div class="grid-2" style="gap:14px;margin-bottom:14px">
            <div class="form-row" style="margin:0">
              <label class="form-label">Tournament Name</label>
              <input type="text" id="tName" class="form-input" placeholder="e.g. Season 1 Cup">
            </div>
            <div class="form-row" style="margin:0">
              <label class="form-label">Description (optional)</label>
              <input type="text" id="tDesc" class="form-input" placeholder="e.g. Winner takes all">
            </div>
          </div>

          <!-- Size picker -->
          <div class="form-row" style="margin-bottom:16px">
            <label class="form-label">Number of Players</label>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              <button class="btn btn-ghost btn-sm size-btn" data-size="8"   onclick="setSize(8)">8</button>
              <button class="btn btn-ghost btn-sm size-btn" data-size="16"  onclick="setSize(16)">16</button>
              <button class="btn btn-cyan  btn-sm size-btn" data-size="32"  onclick="setSize(32)">32</button>
              <button class="btn btn-ghost btn-sm size-btn" data-size="64"  onclick="setSize(64)">64</button>
              <button class="btn btn-ghost btn-sm size-btn" data-size="128" onclick="setSize(128)">128</button>
            </div>
            <div style="font-size:0.72rem;color:var(--text-dim);margin-top:5px" id="sizeHint">
              32-player Â· 8 groups of 4 Â· QF â†’ SF â†’ Final
            </div>
          </div>

          <!-- Format picker -->
          <div class="form-row" style="margin-bottom:20px">
            <label class="form-label">Tournament Format</label>
            <div class="format-toggle">
              <button class="format-opt active" id="fmtGroupKnockout" onclick="setFormat('group_knockout')">
                ğŸŸï¸ Group Stage + Knockout
              </button>
              <button class="format-opt" id="fmtKnockout" onclick="setFormat('knockout')">
                âš¡ Pure Knockout / Cup
              </button>
            </div>
            <div class="format-desc" id="formatDesc">
              Players split into groups. Top 2 per group advance to a knockout bracket through to the Final.
            </div>
          </div>

          <button class="btn btn-cyan btn-lg" onclick="createTournament()">Create Tournament â†’</button>
        </div>
      </div>

      <!-- â”€â”€ TOURNAMENT LIST â”€â”€ -->
      <div class="section-header">
        <div class="section-title">ALL TOURNAMENTS</div>
        <button class="btn btn-ghost btn-sm" onclick="loadAdminTournaments()">â†» Refresh</button>
      </div>
      <div id="adminTournamentList"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ MATCHES MODAL â”€â”€ -->
<div class="modal-backdrop" id="matchModal">
  <div class="modal" style="max-width:720px;width:95vw">
    <div class="modal-title" id="matchModalTitle">MATCHES</div>
    <div id="matchModalMsg"></div>
    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
      <button class="btn btn-ghost btn-sm" onclick="setMatchFilter('all')">All</button>
      <button class="btn btn-ghost btn-sm" onclick="setMatchFilter('pending')">Pending</button>
      <button class="btn btn-ghost btn-sm" onclick="setMatchFilter('confirmed')">Confirmed</button>
    </div>
    <div id="matchModalList" style="max-height:55vh;overflow-y:auto"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeMatchModal()">Close</button>
      <button class="btn btn-red btn-sm" onclick="confirmAllMatches()">Confirm All With Scores</button>
    </div>
  </div>
</div>

<script>
  let adminPwd = '';
  let currentTid = null;
  let allAdminMatches = [];
  let matchFilter = 'all';
  let selectedSize = 32;
  let selectedFormat = 'group_knockout';

  document.getElementById('adminPwd').addEventListener('keydown', e => {
    if (e.key === 'Enter') adminLogin();
  });

  // â”€â”€ Size / Format selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sizeInfo = {
    8:   {
      group_knockout: '8 players Â· 2 groups of 4 Â· SF â†’ Final',
      knockout:       '8 players Â· QF â†’ SF â†’ Final'
    },
    16:  {
      group_knockout: '16 players Â· 4 groups of 4 Â· SF â†’ Final',
      knockout:       '16 players Â· R16 â†’ QF â†’ SF â†’ Final'
    },
    32:  {
      group_knockout: '32 players Â· 8 groups of 4 Â· QF â†’ SF â†’ Final',
      knockout:       '32 players Â· R32 â†’ R16 â†’ QF â†’ SF â†’ Final'
    },
    64:  {
      group_knockout: '64 players Â· 16 groups of 4 Â· R16 â†’ QF â†’ SF â†’ Final',
      knockout:       '64 players Â· R64 â†’ R32 â†’ R16 â†’ QF â†’ SF â†’ Final'
    },
    128: {
      group_knockout: '128 players Â· 32 groups of 4 â†’ R32 â†’ ... â†’ Final',
      knockout:       '128 players Â· R128 â†’ R64 â†’ ... â†’ Final'
    }
  };

  const formatDesc = {
    group_knockout: 'Players split into groups. Top 2 per group advance to a knockout bracket through to the Final.',
    knockout:       'Single elimination cup. Every loss = eliminated. Winner of each match advances to the next round.'
  };

  function updateHints() {
    document.getElementById('sizeHint').textContent    = sizeInfo[selectedSize][selectedFormat];
    document.getElementById('formatDesc').textContent  = formatDesc[selectedFormat];
  }

  window.setSize = function(s) {
    selectedSize = s;
    document.querySelectorAll('.size-btn').forEach(b => {
      b.className = b.dataset.size == s ? 'btn btn-cyan btn-sm size-btn' : 'btn btn-ghost btn-sm size-btn';
    });
    updateHints();
  };

  window.setFormat = function(f) {
    selectedFormat = f;
    document.getElementById('fmtGroupKnockout').className =
      'format-opt' + (f === 'group_knockout' ? ' active' : '');
    document.getElementById('fmtKnockout').className =
      'format-opt' + (f === 'knockout' ? ' active' : '');
    updateHints();
  };

  // â”€â”€ Admin login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function adminLogin() {
    const pwd = document.getElementById('adminPwd').value;
    if (!pwd) return;

    // Verify by attempting a real admin action then cleaning up
    try {
      const testRes = await fetch('/api/tournaments', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: pwd, name: '__test__', max_players: 8, format: 'knockout' })
      });
      if (testRes.status === 403) {
        document.getElementById('loginMsg').innerHTML =
          '<div class="alert alert-error">Wrong password.</div>';
        return;
      }
      const testData = await testRes.json();
      if (testData.tournament?.id) {
        await fetch(`/api/tournaments/${testData.tournament.id}`, {
          method: 'DELETE', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pwd })
        });
      }
    } catch (e) {}

    adminPwd = pwd;
    document.getElementById('loginWrap').style.display  = 'none';
    document.getElementById('adminPanel').style.display = 'flex';
    loadAdminTournaments();
  }

  function adminLogout() {
    adminPwd = '';
    document.getElementById('loginWrap').style.display  = 'flex';
    document.getElementById('adminPanel').style.display = 'none';
    document.getElementById('adminPwd').value = '';
  }

  // â”€â”€ Load tournament list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadAdminTournaments() {
    const res = await fetch('/api/tournaments');
    const tournaments = await res.json();
    const el = document.getElementById('adminTournamentList');

    if (!tournaments.length) {
      el.innerHTML = `
        <div class="empty">
          <div class="empty-icon">ğŸ†</div>
          <div class="empty-title">NO TOURNAMENTS YET</div>
          <div class="empty-sub">Create one above to get started.</div>
        </div>`;
      return;
    }

    const statusMap = {
      registration: { chip: 'chip-green', label: 'â— Open' },
      group_stage:  { chip: 'chip-cyan',  label: 'â— Groups' },
      knockout:     { chip: 'chip-gold',  label: 'â— Knockout' },
      completed:    { chip: 'chip-dim',   label: 'âœ“ Done' },
    };

    const formatLabel = {
      group_knockout: 'ğŸŸï¸ Groups + KO',
      knockout:       'âš¡ Cup / KO',
    };

    el.innerHTML = tournaments.map(t => {
      const s   = statusMap[t.status] || statusMap.completed;
      const pct = Math.round(((t.registered_count || 0) / t.max_players) * 100);
      const fmt = formatLabel[t.format] || t.format;

      // Build contextual action buttons
      let actions = '';

      if (t.status === 'registration') {
        if (t.format === 'group_knockout') {
          actions += `<button class="btn btn-cyan btn-sm" onclick="generateGroups(${t.id})">ğŸ² Generate Groups</button>`;
        } else {
          actions += `<button class="btn btn-cyan btn-sm" onclick="generateKnockout(${t.id})">âš¡ Generate Bracket</button>`;
        }
      }

      if (t.status === 'group_stage') {
        actions += `<button class="btn btn-cyan btn-sm" onclick="openMatchModal(${t.id}, '${esc(t.name)}')">âš½ Manage Matches</button>`;
        actions += `<button class="btn btn-gold btn-sm" onclick="generateKnockout(${t.id})">ğŸ† Generate Knockout</button>`;
      }

      if (t.status === 'knockout') {
        actions += `<button class="btn btn-cyan btn-sm" onclick="openMatchModal(${t.id}, '${esc(t.name)}')">âš½ Manage Matches</button>`;
        actions += `<button class="btn btn-ghost btn-sm" onclick="setStatus(${t.id},'completed')">âœ“ Mark Complete</button>`;
      }

      if (t.status === 'completed') {
        actions += `<button class="btn btn-ghost btn-sm" onclick="openMatchModal(${t.id}, '${esc(t.name)}')">ğŸ“‹ View Results</button>`;
      }

      actions += `<button class="btn btn-ghost btn-sm" style="color:var(--red)" onclick="deleteTournament(${t.id})">ğŸ—‘ Delete</button>`;

      return `
        <div class="t-card">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:10px">
            <div>
              <div class="t-card-name">${t.name}</div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:4px;flex-wrap:wrap">
                <span class="chip ${s.chip}">${s.label}</span>
                <span class="chip chip-dim">${t.max_players} players</span>
                <span class="chip chip-dim">${fmt}</span>
              </div>
            </div>
            <div style="text-align:right;min-width:130px">
              <div style="font-size:0.68rem;letter-spacing:1px;color:var(--text-dim);text-transform:uppercase;margin-bottom:4px">Registrations</div>
              <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
              <div style="font-size:0.72rem;color:var(--text-dim);margin-top:3px">${t.registered_count || 0} / ${t.max_players}</div>
            </div>
          </div>
          <div class="t-card-actions">${actions}</div>
        </div>`;
    }).join('');
  }

  // â”€â”€ Create tournament â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function createTournament() {
    const name = document.getElementById('tName').value.trim();
    const desc = document.getElementById('tDesc').value.trim();
    if (!name) { showAdminMsg('Tournament name required.', 'error'); return; }

    try {
      const res = await fetch('/api/tournaments', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          password:    adminPwd,
          name,
          description: desc,
          max_players: selectedSize,
          format:      selectedFormat
        })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || data.error);
      showAdminMsg(`"${name}" created! (${selectedSize} players, ${selectedFormat === 'knockout' ? 'Cup/Knockout' : 'Group + Knockout'})`, 'success');
      document.getElementById('tName').value = '';
      document.getElementById('tDesc').value = '';
      loadAdminTournaments();
    } catch (err) { showAdminMsg(err.message, 'error'); }
  }

  // â”€â”€ Generate groups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function generateGroups(tid) {
    if (!confirm('Generate random group draw? Registration will close.')) return;
    try {
      showAdminMsg('Generating groups...', 'info');
      const res = await fetch(`/api/tournaments/${tid}/groups/generate`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: adminPwd })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || data.error);
      showAdminMsg(data.message, 'success');
      loadAdminTournaments();
    } catch (err) { showAdminMsg(err.message, 'error'); }
  }

  // â”€â”€ Generate knockout bracket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function generateKnockout(tid) {
    if (!confirm('Generate knockout bracket? This will use current group standings for seeding.')) return;
    try {
      showAdminMsg('Generating bracket...', 'info');
      const res = await fetch(`/api/tournaments/${tid}/matches/generate-knockout`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: adminPwd })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || data.error);
      showAdminMsg(data.message, 'success');
      loadAdminTournaments();
    } catch (err) { showAdminMsg(err.message, 'error'); }
  }

  // â”€â”€ Set status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function setStatus(tid, status) {
    try {
      const res = await fetch(`/api/tournaments/${tid}/status`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: adminPwd, status })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);
      showAdminMsg(data.message, 'success');
      loadAdminTournaments();
    } catch (err) { showAdminMsg(err.message, 'error'); }
  }

  // â”€â”€ Delete tournament â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function deleteTournament(tid) {
    if (!confirm('DELETE this tournament and ALL its data? This cannot be undone.')) return;
    try {
      const res = await fetch(`/api/tournaments/${tid}`, {
        method: 'DELETE', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: adminPwd })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);
      showAdminMsg('Tournament deleted.', 'success');
      loadAdminTournaments();
    } catch (err) { showAdminMsg(err.message, 'error'); }
  }

  // â”€â”€ Match modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openMatchModal(tid, name) {
    currentTid  = tid;
    matchFilter = 'all';
    document.getElementById('matchModalTitle').textContent = `MATCHES â€” ${name.toUpperCase()}`;
    document.getElementById('matchModal').classList.add('open');
    await loadMatchModal();
  }

  async function loadMatchModal() {
    const [mRes, mdRes] = await Promise.all([
      fetch(`/api/tournaments/${currentTid}/matches?all=true`),
      fetch(`/api/tournaments/${currentTid}/matchday`)
    ]);
    allAdminMatches = await mRes.json();
    const mdInfo = await mdRes.json();
    window._adminCurrentMD = mdInfo.current_matchday || 1;
    window._adminTotalMD   = mdInfo.total_matchdays  || 0;
    renderMatchModal();
  }

  window.setMatchFilter = function(f) { matchFilter = f; renderMatchModal(); };

  function renderMatchModal() {
    let list = allAdminMatches;
    if (matchFilter === 'pending')   list = allAdminMatches.filter(m => !m.confirmed);
    if (matchFilter === 'confirmed') list = allAdminMatches.filter(m => m.confirmed);

    const el = document.getElementById('matchModalList');
    if (!list.length) {
      el.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-dim)">No matches found.</div>';
      return;
    }

    // Group matches by matchday (group stage) then knockout stages
    const groupMatches    = list.filter(m => m.stage === 'group');
    const knockoutMatches = list.filter(m => m.stage !== 'group');

    let html = '';

    // Group stage â€” show by matchday
    if (groupMatches.length) {
      const matchdays = [...new Set(groupMatches.map(m => m.matchday || 1))].sort((a,b)=>a-b);
      matchdays.forEach(md => {
        const mdMatches     = groupMatches.filter(m => (m.matchday||1) === md);
        const allConfirmed  = mdMatches.every(m => m.confirmed);
        const hasScores     = mdMatches.filter(m => m.home_score !== null && m.away_score !== null && !m.confirmed).length;
        const isCurrent     = md === window._adminCurrentMD;

        html += `
          <div style="margin-bottom:20px">
            <div style="display:flex;align-items:center;justify-content:space-between;
                        padding:8px 0 10px;border-bottom:1px solid var(--border);margin-bottom:10px;gap:10px;flex-wrap:wrap">
              <div style="display:flex;align-items:center;gap:10px">
                <span style="font-size:0.65rem;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim)">
                  Matchday ${md}
                </span>
                ${isCurrent ? '<span class="chip chip-cyan" style="font-size:0.6rem">Current</span>' : ''}
                ${allConfirmed ? '<span class="chip chip-green" style="font-size:0.6rem">âœ“ All Confirmed</span>' : ''}
              </div>
              ${hasScores && !allConfirmed ? `
                <button class="btn btn-red btn-sm" onclick="confirmMatchday(${md})" style="font-size:0.72rem">
                  Confirm MD${md} (${hasScores} matches)
                </button>` : ''}
            </div>
            ${mdMatches.map(m => matchRow(m)).join('')}
          </div>`;
      });
    }

    // Knockout
    if (knockoutMatches.length) {
      html += `<div style="font-size:0.65rem;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);padding:8px 0 10px;border-bottom:1px solid var(--border);margin-bottom:10px">Knockout Rounds</div>`;
      html += knockoutMatches.map(m => matchRow(m)).join('');
    }

    el.innerHTML = html;
  }

  function matchRow(m) {
    const hasScore  = m.home_score !== null && m.away_score !== null;
    const scoreDisp = hasScore ? `${m.home_score} â€“ ${m.away_score}` : 'â€” vs â€”';
    const stageLabel = (m.stage || 'group').replace(/-/g,' ').replace(/\b\w/g, l => l.toUpperCase());
    const groupTag   = m.group_name ? ` Â· Grp ${m.group_name}` : '';
    const screenshot = m.screenshot_url
      ? `<img src="${m.screenshot_url}" style="width:40px;height:40px;object-fit:cover;border-radius:5px;border:1px solid rgba(0,224,122,0.3);cursor:pointer;flex-shrink:0"
             onclick="window.open('${m.screenshot_url}','_blank')" title="View screenshot">`
      : `<div style="width:40px;height:40px;border-radius:5px;border:1px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:0.7rem;color:var(--text-dim);flex-shrink:0">ğŸ“·</div>`;

    return `
      <div class="match-row">
        <div style="font-size:0.6rem;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);min-width:70px;white-space:nowrap">${stageLabel}${groupTag}</div>
        <div class="match-teams">
          <div style="font-weight:600">${m.home_player}</div>
          <div style="font-size:0.72rem;color:var(--text-dim)">${m.home_team_name}</div>
        </div>
        <div class="match-score-disp">${scoreDisp}</div>
        <div class="match-teams" style="text-align:right">
          <div style="font-weight:600">${m.away_player}</div>
          <div style="font-size:0.72rem;color:var(--text-dim)">${m.away_team_name}</div>
        </div>
        ${screenshot}
        ${m.confirmed
          ? '<span class="chip chip-green" style="white-space:nowrap;flex-shrink:0">âœ“ Locked</span>'
          : `<button class="btn btn-red btn-sm" style="flex-shrink:0"
              onclick="confirmMatch(${m.id})"
              ${!hasScore ? 'disabled title="No score entered yet"' : ''}>Confirm</button>`
        }
      </div>`;
  }

  async function confirmMatch(id) {
    try {
      const res = await fetch(`/api/tournaments/${currentTid}/matches/${id}/confirm`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: adminPwd })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);
      showMatchMsg(data.message, 'success');
      await loadMatchModal();
    } catch (err) { showMatchMsg(err.message, 'error'); }
  }

  async function confirmMatchday(md) {
    if (!confirm(`Confirm all Matchday ${md} matches that have scores?`)) return;
    try {
      const res = await fetch(`/api/tournaments/${currentTid}/matches/confirm-all`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: adminPwd, matchday: md })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);
      showMatchMsg(data.message + ` Matchday ${md+1} now unlocked for players!`, 'success');
      await loadMatchModal();
    } catch (err) { showMatchMsg(err.message, 'error'); }
  }

  async function confirmAllMatches() {
    if (!confirm('Confirm ALL matches across all matchdays that have scores entered?')) return;
    try {
      const res = await fetch(`/api/tournaments/${currentTid}/matches/confirm-all`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: adminPwd })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);
      showMatchMsg(data.message, 'success');
      await loadMatchModal();
    } catch (err) { showMatchMsg(err.message, 'error'); }
  }

  window.closeMatchModal = function() {
    document.getElementById('matchModal').classList.remove('open');
    currentTid = null;
    loadAdminTournaments();
  };

  document.getElementById('matchModal').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeMatchModal();
  });

  function showAdminMsg(text, type = 'info') {
    const el = document.getElementById('adminMsg');
    el.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
    if (type !== 'error') setTimeout(() => el.innerHTML = '', 5000);
  }

  function showMatchMsg(text, type = 'info') {
    const el = document.getElementById('matchModalMsg');
    el.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
    if (type !== 'error') setTimeout(() => el.innerHTML = '', 3000);
  }

  function esc(str) {
    return (str || '').replace(/'/g, "\\'");
  }
</script>
</body>
</html>
